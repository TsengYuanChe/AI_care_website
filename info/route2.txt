# apps/routes.py
from flask import render_template, request, flash, redirect, url_for
from your_application import app, db
from your_application.models import RawArticle, Category, FilteredArticle

@app.route('/articles')
def articles():
    # 獲取查詢參數
    page = request.args.get('page', 1, type=int)
    selected_category = request.args.get('category', None, type=str)
    search_query = request.args.get('query', '', type=str)

    # 獲取所有分類
    categories = Category.query.order_by(Category.name).all()

    # 根據分類和搜尋查詢篩選文章
    articles_query = FilteredArticle.query

    if selected_category:
        category = Category.query.filter_by(name=selected_category).first_or_404()
        articles_query = articles_query.filter_by(category=category)

    if search_query:
        articles_query = articles_query.filter(
            FilteredArticle.title.ilike(f'%{search_query}%') |
            FilteredArticle.content.ilike(f'%{search_query}%')
        )

    # 按瀏覽次數排序，並進行分頁
    articles_pagination = articles_query.order_by(FilteredArticle.view_count.desc()).paginate(page=page, per_page=10)

    return render_template('articles.html',
                           articles=articles_pagination,
                           categories=categories,
                           selected_category=selected_category,
                           search_query=search_query)

@app.route('/view_article/<int:article_id>')
def view_article(article_id):
    article = FilteredArticle.query.get_or_404(article_id)
    # 增加瀏覽次數
    article.view_count += 1
    db.session.commit()
    return render_template('view_article.html', article=article)